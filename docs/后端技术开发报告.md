# 电竞比赛模拟器2 - 后端技术开发报告

## 一、项目概述

### 1.1 项目背景
基于策划案《电竞比赛模拟器网页项目策划书》，开发一款轻量化、高还原度的电竞赛事模拟桌面应用。

### 1.2 技术架构选型
| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 前端框架 | Vue3 + TypeScript | 响应式UI开发 |
| UI框架 | TailwindCSS + NativeUI | 原生风格界面 |
| 桌面框架 | Tauri 2.x | 跨平台桌面应用 |
| 后端语言 | Rust | Tauri原生后端 |
| 本地数据库 | SQLite | 单机存档存储 |
| 云端数据库 | MySQL 8.0 | 可选云同步功能 |
| ORM框架 | SQLx | 异步数据库操作 |

### 1.3 架构模式
采用**混合模式架构**：
- **本地优先**：使用SQLite作为主要存储，保证离线可用
- **云端可选**：提供MySQL云同步功能，支持多设备存档同步

```
┌─────────────────────────────────────────────────────────┐
│                    Tauri 桌面应用                        │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────────────┐    │
│  │   Vue3 前端     │◄──►│   Tauri IPC Bridge      │    │
│  │  (WebView)      │    │   (Commands/Events)     │    │
│  └─────────────────┘    └───────────┬─────────────┘    │
│                                     │                   │
│  ┌──────────────────────────────────▼────────────────┐ │
│  │              Rust 后端核心                         │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────────────┐  │ │
│  │  │比赛模拟  │ │ 赛事管理 │ │  选手/转会系统   │  │ │
│  │  │ 引擎     │ │  引擎    │ │     引擎         │  │ │
│  │  └──────────┘ └──────────┘ └──────────────────┘  │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────────────┐  │ │
│  │  │年度积分  │ │ 时间推进 │ │    存档管理      │  │ │
│  │  │ 引擎     │ │  引擎    │ │     系统         │  │ │
│  │  └──────────┘ └──────────┘ └──────────────────┘  │ │
│  └───────────────────────┬───────────────────────────┘ │
│                          │                              │
│  ┌───────────────────────▼───────────────────────────┐ │
│  │              数据访问层 (SQLx)                     │ │
│  │  ┌─────────────────┐    ┌─────────────────────┐  │ │
│  │  │  SQLite本地存储  │◄──►│  MySQL云端同步(可选) │  │ │
│  │  └─────────────────┘    └─────────────────────┘  │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

---

## 二、核心模块设计

### 2.1 比赛模拟引擎 (MatchSimulationEngine)

#### 2.1.1 选手战力计算子引擎
```rust
/// 选手实际能力计算
/// 公式: 实际能力 = clamp(基础能力 + 状态加成 + 高斯噪声, 下限, 上限)
pub struct PlayerPerformanceEngine {
    /// 选手基础能力值
    base_power: f64,
    /// 年龄 (影响稳定性和状态加成上限)
    age: u8,
    /// 稳定性 (由年龄决定: 18-24岁=60-75, 25-29岁=75-85, 30+岁=85-95)
    stability: f64,
    /// 状态加成 (受年龄限制: 年轻人可达+8, 老将一般+2以内)
    form_bonus: f64,
}

impl PlayerPerformanceEngine {
    /// 计算标准差 σ = (100 - 稳定性) / 10
    fn calculate_std_dev(&self) -> f64;

    /// 基于Box-Muller变换的高斯随机数生成
    fn gaussian_random(&self, mean: f64, std_dev: f64) -> f64;

    /// 计算单局比赛的实际发挥值
    /// 下限 = max(0, 基础能力 - 15)
    /// 上限 = min(100, 基础能力 + 10)
    pub fn calculate_performance(&self) -> f64;
}
```

#### 2.1.2 比赛模拟主引擎
```rust
/// 比赛模拟引擎 - 基于正态分布的胜负判定
pub struct MatchSimulationEngine {
    /// 标准差 (控制发挥波动程度)
    std_dev: f64, // 默认值: 6.0
}

impl MatchSimulationEngine {
    /// 计算队伍战力值 = Σ(选手能力值 / 5)
    fn calculate_team_power(&self, players: &[Player]) -> f64;

    /// 模拟单局比赛
    /// 1. 计算双方临场发挥值 (正态分布)
    /// 2. 发挥值高者获胜
    pub fn simulate_game(&self, home_team: &Team, away_team: &Team) -> GameResult;

    /// 模拟BO系列赛 (BO1/BO3/BO5)
    pub fn simulate_match(&self, home: &Team, away: &Team, format: MatchFormat) -> MatchResult;
}
```

### 2.2 时间推进引擎 (SeasonProgressEngine)

```rust
/// 赛季阶段枚举
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub enum SeasonPhase {
    SpringRegularSeason,      // 春季赛常规赛
    SpringPlayoffs,           // 春季赛季后赛
    MSI,                      // MSI季中赛
    MadridMasters,            // 马德里大师赛
    SummerRegularSeason,      // 夏季赛常规赛
    SummerPlayoffs,           // 夏季赛季后赛
    ClaudeIntercontinental,   // Claude洲际赛
    WorldChampionship,        // S世界赛
    ShanghaiMasters,          // 上海大师赛
    ICPIntercontinental,      // ICP四赛区洲际对抗赛
    SuperIntercontinental,    // Super洲际年度邀请赛
    TransferWindow,           // 转会期
    Draft,                    // 选秀
    SeasonEnd,                // 赛季结束
}

pub struct SeasonProgressEngine {
    current_season: u32,      // 当前赛季 (S1, S2, ...)
    current_phase: SeasonPhase,
    phase_completed: bool,
}

impl SeasonProgressEngine {
    /// 检查是否可以进入下一阶段
    pub fn can_advance(&self) -> bool;

    /// 推进到下一阶段
    pub fn advance_phase(&mut self) -> Result<SeasonPhase, Error>;

    /// 获取当前阶段可执行的操作
    pub fn get_available_actions(&self) -> Vec<GameAction>;

    /// 验证操作是否在当前阶段允许
    pub fn validate_action(&self, action: &GameAction) -> bool;
}
```

### 2.3 年度积分引擎 (PointsCalculationEngine)

```rust
/// 积分奖励配置
pub struct PointsConfig {
    // 联赛季后赛积分
    league_champion: u32,     // 12分
    league_runner_up: u32,    // 10分
    league_third: u32,        // 8分
    league_fourth: u32,       // 6分
    league_5th_8th: u32,      // 3分

    // MSI/上海大师赛积分
    msi_champion: u32,        // 20分
    msi_runner_up: u32,       // 16分
    // ... 其他配置
}

pub struct PointsCalculationEngine {
    config: PointsConfig,
}

impl PointsCalculationEngine {
    /// 计算单场赛事积分
    pub fn calculate_event_points(&self, event: &Event, results: &EventResults) -> Vec<TeamPoints>;

    /// 更新年度积分排名
    pub fn update_annual_rankings(&self, teams: &mut [Team], event_points: &[TeamPoints]);

    /// 获取全球Top16排名 (用于洲际超级杯赛资格)
    pub fn get_global_top16(&self, teams: &[Team]) -> Vec<&Team>;
}
```

### 2.4 选手系统 (PlayerSystem)

```rust
/// 选手标签
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum PlayerTag {
    Ordinary,   // 平庸 - 每赛季+1能力
    Normal,     // 一般 - 每赛季+2能力
    Genius,     // 天才 - 每赛季+3能力
}

/// 选手状态
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum PlayerStatus {
    Active,     // 在役
    Retired,    // 退役
}

/// 选手数据结构
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Player {
    pub id: u64,
    pub game_id: String,          // 游戏ID
    pub real_name: String,        // 真实姓名
    pub nationality: String,      // 国籍
    pub age: u8,                  // 年龄 (16-30)
    pub ability: u8,              // 当前能力值 (0-100)
    pub potential: u8,            // 潜力值上限
    pub stability: u8,            // 稳定性
    pub tag: PlayerTag,           // 标签
    pub status: PlayerStatus,     // 状态
    pub team_id: Option<u64>,     // 所属战队
    pub join_season: u32,         // 加入赛季
    pub retire_season: Option<u32>, // 退役赛季
    pub salary: u64,              // 年薪(万元)
    pub market_value: u64,        // 身价(万元)
    pub contract_end_season: u32, // 合同到期赛季
}

impl PlayerSystem {
    /// 赛季结束时更新选手属性
    pub fn season_end_update(&mut self, players: &mut [Player], current_season: u32) {
        for player in players.iter_mut() {
            // 1. 年龄+1
            player.age += 1;

            // 2. 根据标签增加能力值 (不超过潜力值)
            let growth = match player.tag {
                PlayerTag::Ordinary => 1,
                PlayerTag::Normal => 2,
                PlayerTag::Genius => 3,
            };
            player.ability = (player.ability + growth).min(player.potential);

            // 3. 检查退役 (年龄>30)
            if player.age > 30 {
                player.status = PlayerStatus::Retired;
                player.retire_season = Some(current_season);
                player.team_id = None;
            }

            // 4. 更新稳定性 (根据新年龄)
            player.stability = self.calculate_stability(player.age);
        }
    }

    /// 根据年龄计算稳定性
    fn calculate_stability(&self, age: u8) -> u8;
}
```

### 2.5 选秀系统 (DraftSystem)

```rust
/// 选秀系统 - 每4个赛季进行一次 (S2, S6, S10...)
pub struct DraftSystem {
    draft_pool: Vec<DraftPlayer>,   // 选秀池 (14人)
    draft_order: Vec<u64>,          // 选秀顺序 (队伍ID)
}

/// 选秀球员
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DraftPlayer {
    pub rank: u8,                   // 选秀排名 (1=状元, 2=榜眼, 3=探花, ...)
    pub player: Player,
}

impl DraftSystem {
    /// 检查是否是选秀年
    pub fn is_draft_year(season: u32) -> bool {
        season >= 2 && (season - 2) % 4 == 0
    }

    /// 生成选秀顺序 (基于夏季赛排名的概率算法)
    /// 排名越靠后,获得高顺位的概率越高
    pub fn generate_draft_order(&mut self, teams: &[Team], region: Region) -> Vec<DraftPick>;

    /// 导入选秀池
    pub fn import_draft_pool(&mut self, players: Vec<DraftPlayer>) -> Result<(), Error>;

    /// 执行选秀
    pub fn execute_draft(&mut self) -> Vec<DraftResult>;
}
```

### 2.6 转会系统 (TransferSystem)

```rust
/// 转会类型
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum TransferType {
    FreeAgent,      // 自由球员签约
    Purchase,       // 主动求购
    Sale,           // 被动出售
    Retirement,     // 退役
    Loan,           // 租借
}

/// 财政状态
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum FinancialStatus {
    Wealthy,        // 富裕 (>1000万)
    Healthy,        // 健康 (500-1000万)
    Tight,          // 紧张 (100-500万)
    Deficit,        // 赤字 (0-100万)
    Bankrupt,       // 破产 (<0)
}

/// 转会AI引擎
pub struct TransferAI {
    /// AI评估球队需求
    fn evaluate_team_needs(&self, team: &Team) -> TeamNeeds;

    /// AI生成买入决策
    fn generate_buy_decision(&self, team: &Team, market: &TransferMarket) -> Option<TransferOffer>;

    /// AI生成卖出决策
    fn generate_sell_decision(&self, team: &Team) -> Vec<PlayerListing>;

    /// 自由球员选择球队 (基于薪资40%+竞争力30%+上场机会20%+随机10%)
    fn free_agent_decision(&self, player: &Player, offers: &[TeamOffer]) -> Option<u64>;
}

/// 财政系统
pub struct FinancialSystem {
    /// 计算赛季收入
    pub fn calculate_season_income(&self, team: &Team, results: &SeasonResults) -> u64;

    /// 计算赛季支出
    pub fn calculate_season_expense(&self, team: &Team) -> u64;

    /// 获取财政状态
    pub fn get_financial_status(&self, balance: i64) -> FinancialStatus;
}
```

### 2.7 存档系统 (SaveSystem)

```rust
/// 存档数据结构
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SaveData {
    pub id: Uuid,
    pub name: String,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
    pub current_season: u32,
    pub current_phase: SeasonPhase,
    pub teams: Vec<Team>,
    pub players: Vec<Player>,
    pub match_history: Vec<MatchRecord>,
    pub point_rankings: Vec<PointRanking>,
    pub honors: Vec<Honor>,
    pub transfer_history: Vec<TransferRecord>,
    pub financial_records: Vec<FinancialRecord>,
}

pub struct SaveSystem {
    local_db: SqliteConnection,
    cloud_db: Option<MySqlConnection>,
}

impl SaveSystem {
    /// 创建新存档
    pub async fn create_save(&self, name: &str) -> Result<SaveData, Error>;

    /// 加载存档
    pub async fn load_save(&self, id: Uuid) -> Result<SaveData, Error>;

    /// 保存存档 (自动保存到本地)
    pub async fn save(&self, data: &SaveData) -> Result<(), Error>;

    /// 同步到云端 (可选)
    pub async fn sync_to_cloud(&self, data: &SaveData) -> Result<(), Error>;

    /// 从云端拉取
    pub async fn pull_from_cloud(&self, id: Uuid) -> Result<SaveData, Error>;

    /// 导出存档文件
    pub fn export_save(&self, data: &SaveData, path: &Path) -> Result<(), Error>;

    /// 导入存档文件
    pub fn import_save(&self, path: &Path) -> Result<SaveData, Error>;
}
```

---

## 三、赛事系统详细设计

### 3.1 联赛系统 (LeagueSystem)

```rust
/// 联赛类型
pub enum LeagueType {
    Spring,     // 春季赛
    Summer,     // 夏季赛
}

/// 常规赛积分规则
pub struct RegularSeasonPoints {
    win_2_0: u8,    // 2:0胜 = 3分
    win_2_1: u8,    // 2:1胜 = 2分
    lose_1_2: u8,   // 1:2负 = 1分
    lose_0_2: u8,   // 0:2负 = 0分
}

pub struct LeagueSystem {
    /// 生成常规赛赛程 (BO3双循环)
    pub fn generate_regular_schedule(&self, teams: &[Team]) -> Vec<Match>;

    /// 计算积分榜排名
    /// 排序规则: 积分 > 历史交锋胜率 > 净胜小局数
    pub fn calculate_standings(&self, matches: &[MatchResult]) -> Vec<Standing>;

    /// 生成季后赛对阵 (双败BO5)
    pub fn generate_playoff_bracket(&self, standings: &[Standing]) -> PlayoffBracket;
}
```

### 3.2 国际赛事系统

#### MSI/上海大师赛 (12队双败制)
```rust
pub struct MSISystem {
    /// 资格赛组 (4队) → 2队晋级败者组第一轮
    pub fn run_qualifier_stage(&self, teams: &[Team; 4]) -> Vec<MatchResult>;

    /// 挑战者组 (4队) → 2胜者进败者组第二轮, 2败者进败者组第一轮
    pub fn run_challenger_stage(&self, teams: &[Team; 4]) -> Vec<MatchResult>;

    /// 传奇组 (4队) → 直接进入胜者组
    /// ... 完整双败制流程
}
```

#### 马德里大师赛/Claude洲际赛 (32队分组+淘汰)
```rust
pub struct MastersTournament {
    /// 分组阶段: 8组×4队, BO3单循环
    pub fn run_group_stage(&self, groups: &[Group; 8]) -> Vec<GroupResult>;

    /// 淘汰赛: 东西半区各8队, BO5单淘汰
    pub fn run_knockout_stage(&self, qualified: &[Team; 16]) -> KnockoutResult;
}
```

#### 世界赛 (瑞士轮+淘汰)
```rust
pub struct WorldChampionship {
    /// 小组赛: 8队BO1瑞士轮, 4队晋级
    pub fn run_swiss_stage(&self, teams: &[Team; 8]) -> SwissResult;

    /// 淘汰赛: 8队BO5单淘汰 + 季军赛
    pub fn run_knockout_stage(&self, teams: &[Team; 8]) -> KnockoutResult;
}
```

#### 洲际超级杯赛 (16队四阶段制)
```rust
pub struct SuperCup {
    /// 第一阶段: Fighter组预选赛 (8队分2组, BO3单循环)
    pub fn run_fighter_stage(&self, fighters: &[Team; 8]) -> FighterResult;

    /// 第二阶段: 挑战者组定位赛 + 晋级赛
    pub fn run_challenger_stage(&self, challengers: &[Team; 4], fighter_winners: &[Team; 2]) -> ChallengerResult;

    /// 第三阶段: 冠军赛预备战 (胜者组+败者组)
    pub fn run_preparation_stage(&self, teams: &[Team; 4]) -> PreparationResult;

    /// 第四阶段: 终极冠军赛 (6队含季军加赛)
    pub fn run_finals(&self, legends: &[Team; 4], qualifiers: &[Team; 2]) -> ChampionResult;
}
```

---

## 四、Tauri IPC 命令设计

### 4.1 命令注册
```rust
#[tauri::command]
async fn create_save(name: String, state: State<'_, AppState>) -> Result<SaveData, String>;

#[tauri::command]
async fn load_save(id: String, state: State<'_, AppState>) -> Result<SaveData, String>;

#[tauri::command]
async fn get_teams(region: Option<String>, state: State<'_, AppState>) -> Result<Vec<Team>, String>;

#[tauri::command]
async fn simulate_match(
    home_id: u64,
    away_id: u64,
    format: String,
    state: State<'_, AppState>
) -> Result<MatchResult, String>;

#[tauri::command]
async fn advance_season_phase(state: State<'_, AppState>) -> Result<SeasonPhase, String>;

#[tauri::command]
async fn generate_league_schedule(
    region: String,
    league_type: String,
    state: State<'_, AppState>
) -> Result<Vec<Match>, String>;

#[tauri::command]
async fn execute_draft(region: String, state: State<'_, AppState>) -> Result<Vec<DraftResult>, String>;

#[tauri::command]
async fn process_transfers(state: State<'_, AppState>) -> Result<Vec<TransferEvent>, String>;

// ... 更多命令
```

### 4.2 事件发送
```rust
/// 比赛进度事件
app.emit("match-progress", MatchProgressPayload { ... });

/// 转会事件
app.emit("transfer-event", TransferEventPayload { ... });

/// 赛季阶段变更事件
app.emit("phase-changed", PhaseChangedPayload { ... });
```

---

## 五、项目结构

```
src-tauri/
├── Cargo.toml
├── tauri.conf.json
├── src/
│   ├── main.rs                 # 入口文件
│   ├── lib.rs                  # 库入口
│   ├── commands/               # Tauri IPC 命令
│   │   ├── mod.rs
│   │   ├── save.rs            # 存档相关命令
│   │   ├── team.rs            # 战队相关命令
│   │   ├── player.rs          # 选手相关命令
│   │   ├── match_sim.rs       # 比赛模拟命令
│   │   ├── league.rs          # 联赛相关命令
│   │   ├── tournament.rs      # 杯赛相关命令
│   │   ├── draft.rs           # 选秀相关命令
│   │   └── transfer.rs        # 转会相关命令
│   │
│   ├── engines/                # 核心引擎
│   │   ├── mod.rs
│   │   ├── match_simulation.rs    # 比赛模拟引擎
│   │   ├── player_performance.rs  # 选手战力引擎
│   │   ├── season_progress.rs     # 时间推进引擎
│   │   ├── points_calculation.rs  # 积分计算引擎
│   │   ├── draft.rs               # 选秀引擎
│   │   └── transfer_ai.rs         # 转会AI引擎
│   │
│   ├── models/                 # 数据模型
│   │   ├── mod.rs
│   │   ├── team.rs
│   │   ├── player.rs
│   │   ├── match_record.rs
│   │   ├── season.rs
│   │   ├── tournament.rs
│   │   ├── honor.rs
│   │   └── financial.rs
│   │
│   ├── services/               # 业务服务
│   │   ├── mod.rs
│   │   ├── league_service.rs
│   │   ├── tournament_service.rs
│   │   ├── player_service.rs
│   │   ├── transfer_service.rs
│   │   └── financial_service.rs
│   │
│   ├── db/                     # 数据库操作
│   │   ├── mod.rs
│   │   ├── sqlite.rs          # SQLite本地存储
│   │   ├── mysql.rs           # MySQL云同步
│   │   ├── migrations/        # 数据库迁移
│   │   └── repository/        # 数据仓库
│   │       ├── team_repo.rs
│   │       ├── player_repo.rs
│   │       ├── match_repo.rs
│   │       └── ...
│   │
│   ├── utils/                  # 工具函数
│   │   ├── mod.rs
│   │   ├── random.rs          # 随机数工具(Box-Muller)
│   │   └── validator.rs       # 数据验证
│   │
│   └── state.rs               # 应用状态管理
│
└── migrations/                 # SQLx迁移文件
    ├── 20240101000000_init.sql
    └── ...
```

---

## 六、依赖配置 (Cargo.toml)

```toml
[package]
name = "esport-manager-2"
version = "0.1.0"
edition = "2021"

[dependencies]
# Tauri框架
tauri = { version = "2", features = ["shell-open"] }
tauri-plugin-shell = "2"

# 异步运行时
tokio = { version = "1", features = ["full"] }

# 数据库
sqlx = { version = "0.7", features = ["runtime-tokio", "sqlite", "mysql", "uuid", "chrono"] }

# 序列化
serde = { version = "1", features = ["derive"] }
serde_json = "1"

# 时间处理
chrono = { version = "0.4", features = ["serde"] }

# UUID生成
uuid = { version = "1", features = ["v4", "serde"] }

# 随机数
rand = "0.8"
rand_distr = "0.4"  # 用于正态分布

# 错误处理
thiserror = "1"
anyhow = "1"

# 日志
tracing = "0.1"
tracing-subscriber = "0.3"

[build-dependencies]
tauri-build = { version = "2", features = [] }
```

---

## 七、开发里程碑

### Phase 1: 基础架构
- [ ] Tauri项目初始化
- [ ] SQLite数据库集成
- [ ] 基础数据模型定义
- [ ] 存档系统实现

### Phase 2: 核心引擎
- [ ] 比赛模拟引擎
- [ ] 选手战力计算引擎
- [ ] 时间推进引擎
- [ ] 年度积分引擎

### Phase 3: 赛事系统
- [ ] 联赛系统 (春/夏季赛)
- [ ] MSI/上海大师赛
- [ ] 马德里大师赛/Claude洲际赛
- [ ] 世界赛
- [ ] 洲际超级杯赛
- [ ] ICP四赛区洲际对抗赛

### Phase 4: 选手与转会
- [ ] 选手系统
- [ ] 选秀系统
- [ ] 转会市场AI
- [ ] 财政系统

### Phase 5: 云同步与优化
- [ ] MySQL云同步功能
- [ ] 性能优化
- [ ] 错误处理完善
- [ ] 单元测试
