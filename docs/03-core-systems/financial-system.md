# 财政系统

## 概述

财政系统管理球队的收入、支出和财务状态。保持健康的财政状况是球队生存和发展的关键。系统通过品牌价值驱动赞助收入、差异化联盟分成和弱队保护机制，实现动态的经济生态平衡。

## 货币单位

- 游戏内部使用 **元**
- 显示时转换为 **万元**（前端 `formatMoney` 系列函数）

## 核心概念

### 品牌价值 (brand_value)

队伍长期竞争力的经济指标，范围 0-100，影响赞助收入。

- **初始值**: 由战力映射，`(power_rating - 50) × 2`，如 power 75 → brand 50
- **自然衰减**: 每赛季 × 0.85（即 -15%）
- **荣誉加成**: 赛事成绩累加品牌，冠军加成最高
- **数据库字段**: `teams.brand_value REAL NOT NULL DEFAULT 50.0`

**品牌动态示例**：

| 初始值 | 赛季成绩 | 衰减后 | 荣誉加成 | 赛季末值 |
|--------|---------|--------|---------|---------|
| 50.0 | 无成绩 | 42.5 | +0 | 42.5 |
| 50.0 | 世界赛冠军 | 42.5 | +25 | 67.5 |
| 67.5 | 联赛亚军 | 57.4 | +4 | 61.4 |
| 42.5 | 无成绩 | 36.1 | +0 | 36.1 |

### 荣誉品牌加成表

| 赛事 | 冠军 | 亚军 | 季军 | 殿军 |
|------|------|------|------|------|
| 世界赛 | +25 | +15 | +10 | +5 |
| Super洲际赛 | +20 | +12 | +8 | +5 |
| MSI | +10 | +6 | +3 | — |
| 夏季季后赛 | +8 | +4 | +3 | — |
| 春季季后赛 | +5 | +3 | +2 | — |
| 其他国际赛 | +5 | +3 | +2 | +2 |

## 收入来源

### 赞助收入（品牌价值驱动）

```
赞助 = 基础(50万~500万) × 战力系数 × 胜率加成
基础 = 500,000 + (brand_value/100) × 4,500,000
```

| 参数 | 条件 | 系数 |
|------|------|------|
| 战力系数 | power 70+ | 1.4 |
| | power 65-69 | 1.2 |
| | power 60-64 | 1.0 |
| | power 55-59 | 0.85 |
| | power 50-54 | 0.7 |
| | power <50 | 0.5 |
| 胜率加成 | win_rate >0.7 | 1.3 |
| | win_rate >0.5 | 1.1 |
| | 其他 | 1.0 |

**赞助收入范围示例**（万元）：

| 队伍类型 | brand | power | win_rate | 赞助收入 |
|---------|-------|-------|----------|---------|
| 弱队 | 10 | 55 | 0.3 | ~54万 |
| 中游 | 40 | 63 | 0.5 | ~208万 |
| 强队 | 70 | 75 | 0.65 | ~478万 |
| 王朝 | 95 | 85 | 0.8 | ~867万 |

### 联盟分成（赛区+排名差异化）

```
联盟分成 = 赛区基础 + 排名加成
```

| 赛区 | 基础 | 说明 |
|------|------|------|
| LPL (CN) | 200万 | 最大经济体 |
| LCK (KR) | 175万 | |
| LEC (EU) | 150万 | |
| LCS (NA) | 125万 | |

| 排名 | 加成 |
|------|------|
| 前3名 | +50万 |
| 4-7名 | +25万 |
| 8-10名 | +10万 |
| 11名及以下 | +0 |

**范围**: 125万（LCS 下游）~ 250万（LPL 冠军）

### 弱队补贴金

综合「余额差距」和「排名倒数」两个维度，独立计算、可叠加：

**余额差距补贴**：
- 触发条件：低于赛区平均余额 200万以上
- 金额：差距的 20%，上限 500万

**排名补贴**（赛区倒数4名）：
- 末位: +100万
- 倒数第2: +75万
- 倒数第3-4: +50万

| 场景 | 余额 | 联盟均值 | 排名 | 补贴 |
|------|------|---------|------|------|
| 中游 | 600万 | 800万 | 7 | 0（差距<200万） |
| 偏弱 | 300万 | 800万 | 11 | 100万+50万=150万 |
| 垫底 | 50万 | 800万 | 14 | 150万+100万=250万 |

### 赛事奖金

| 赛事 | 奖金池 | 冠军奖金 |
|------|--------|---------|
| MSI | 4000万 | 2000万 (50%) |
| 世界赛 | 1.2亿 | 5000万 (41.67%) |
| Super洲际赛 | 1.5亿 | 6000万 (40%) |
| 马德里大师赛 | 2000万 | 800万 (40%) |
| Claude洲际赛 | 2000万 | 800万 (40%) |
| 上海大师赛 | 2500万 | 1000万 (40%) |
| ICP洲际赛 | 3000万 | 1200万 (40%) |
| 春季季后赛 | 200万 | 70万 (35%) |
| 夏季季后赛 | 200万 | 70万 (35%) |

### 其他收入

| 收入项 | 说明 |
|--------|------|
| 转会收入 | 卖出选手获得转会费 |

## 支出项目

### 选手薪资

最大支出项，赛季开始时扣除所有 Active 选手的薪资总和。

### 运营成本（阵容挂钩）

```
运营成本 = 150万基础 + 薪资总额 × 15%
```

| 阵容类型 | 总薪资 | 运营成本 |
|---------|--------|---------|
| 低薪 | 500万 | 225万 |
| 中等 | 1000万 | 300万 |
| 高薪 | 2000万 | 450万 |

### 其他支出

| 支出项 | 说明 |
|--------|------|
| 转会支出 | 买入选手的转会费 |

## 财政状态

| 状态 | 资金范围 | 影响 |
|-----|---------|------|
| 富裕 (Wealthy) | >1000万 | 可自由引援 |
| 健康 (Healthy) | 500-1000万 | 正常运营 |
| 紧张 (Tight) | 100-500万 | 限制高薪签约 |
| 赤字 (Deficit) | 0-100万 | 必须出售选手 |
| 破产 (Bankrupt) | <0 | 强制出售最高薪选手 |

## 财政AI决策

| 状态 | 引援策略 | 薪资策略 | 出售策略 |
|------|---------|---------|---------|
| 富裕 | 积极引援，愿付溢价 | 给核心加薪续约 | 不主动出售 |
| 健康 | 正常参与市场 | 按市场价签约 | 按需出售 |
| 紧张 | 优先性价比 | 不主动加薪 | 考虑出售高薪低能 |
| 赤字 | 不参与买入 | — | 必须出售回血（挂牌价可降至身价60%） |
| 破产 | — | — | 系统强制出售最高薪选手 |

## 赛季结算流程

```
年度颁奖 → 更新品牌价值(荣誉加成+衰减)
        → 重算选手身价
转会期   → 发放联盟分成(含弱队补贴)
        → 支付赛季薪资
        → 发放赞助收入
        → 扣除运营成本
```

## 数据结构

### TeamFinanceSummary

```rust
pub struct TeamFinanceSummary {
    pub team_id: u64,
    pub team_name: String,
    pub balance: i64,
    pub total_income: u64,
    pub total_expense: u64,
    pub financial_status: String,
    pub is_crisis: bool,
    pub transfer_budget: i64,
    pub max_new_salary: u64,
    pub projected_season_profit: i64,
    pub total_salary: u64,
    pub brand_value: f64,       // 品牌价值 0-100
    pub sponsorship: u64,       // 当前赞助收入
}
```

### SeasonFinanceReport

```rust
pub struct SeasonFinanceReport {
    pub team_id: u64,
    pub season_id: u64,
    pub opening_balance: i64,
    pub closing_balance: i64,
    pub total_income: u64,
    pub total_expense: u64,
    pub financial_status: String,
    pub salary_expense: u64,    // 薪资支出
    pub prize_money: u64,       // 赛事奖金
    pub sponsorship: u64,       // 赞助收入
    pub league_share: u64,      // 联盟分成
    pub transfer_net: i64,      // 转会净收入
    pub operating_cost: u64,    // 运营成本
}
```

## API 接口

| 接口 | 描述 |
|------|------|
| `get_team_finance_summary(team_id)` | 获取战队财务摘要（含品牌价值和赞助） |
| `get_all_teams_finance(region_id?)` | 获取所有战队财务列表 |
| `get_team_transactions(team_id, season_id?)` | 获取交易记录 |
| `get_season_finance_report(team_id, season_id?)` | 获取赛季财务报告（含收支明细） |
| `distribute_league_share(region_id)` | 发放差异化联盟分成+弱队补贴 |
| `distribute_tournament_prizes(tournament_id, results)` | 发放赛事奖金 |
| `pay_team_salaries(team_id)` | 支付队伍薪资 |
| `get_prize_pool_info(tournament_type)` | 获取奖金池配置 |
| `get_team_prize_details(team_id, season_id?)` | 获取赛事奖金明细 |

## 文件位置

| 文件 | 说明 |
|------|------|
| `src-tauri/src/engines/financial.rs` | 财政引擎（赞助/分成/运营成本/弱队补贴计算） |
| `src-tauri/src/commands/finance_commands.rs` | 财政命令接口（前端调用入口） |
| `src-tauri/src/models/team.rs` | Team 模型（含 brand_value 字段） |
| `src-tauri/src/services/game_flow.rs` | 品牌价值赛季更新逻辑 |
| `src/api/tauri.ts` | 前端类型定义 |
| `src/components/finance/TeamFinanceDialog.vue` | 财务详情弹窗 |
